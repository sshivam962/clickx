:javascript
  updateChatList = function(data) {
    $('.messaging-messages-list').append("<div class='messaging-messages-list-item chat_item' data-thread_id=" + data.chat_thread_id + " id='chat_thread_"+ data.chat_thread_id +"'><a class='p-3 block hover:bg-gray-100 transition-all group'><div class='flex'><div class='col-auto pr-3'><div class='w-12 h-12 leading-10 p-1 bg-gray-300 rounded-full text-center font-medium'>" + data.logo + "</div></div><div class='flex-1 overflow-hidden pt-2'><div class='flex justify-between leading-none pb-2'><div class='text-gray-900 text-sm truncate font-medium'>" + data.username + "</div></div></div></div></a></div>");
  };
  updateChat = function(data) {
    if(data.user_type == "contractor") {
      $(".chat-box-" + data.chat_thread_id).append("<div class='flex justify-end mb-8'><div class='col flex-1 max-w-screen-sm pr-4'><div class='chat-bubble text-right'><div class='text-sm text-right text-gray-600 pb-1 chat-username'>" + data.username + "</div><div class='bg-blue py-3 px-6 rounded-2xl rounded-tr-none text-sm text-white inline-block chat-message text-left'>" + data.message + "</div><div class='text-gray-500 text-xs pt-2'>" + data.time + "</div></div></div><div class='col-auto'><div class='w-8 h-8 sm:w-12 sm:h-12 rounded-full bg-blue text-white p-1 text-2xl text-center'><i class='fa fa-user sm:leading-10 leading-6 align-top'></i></div></div><div>");
      $(".messaging-wrapper-messages").animate({scrollTop: $('.messaging-wrapper-messages').get(0).scrollHeight}, 500);
      $("#latest_message_" + data.chat_thread_id).html(data.message);
      $("#message_time_" + data.chat_thread_id).html("<div class='col-auto pl-3 text-xs text-gray-400 whitespace-no-wrap'>" + data.message_time + "</div>");

      if($('.new-messages').length == '1') {
        $('.new-messages').hide();
      };
      $("#chat_thread_" + data.chat_thread_id).remove();
      $('.messaging-messages-list').prepend("<div class='messaging-messages-list-item chat_item active-chat' data-thread_id= "+ data.chat_thread_id +" id='chat_thread_"+ data.chat_thread_id +"'><div class='p-3 block hover:bg-gray-100 transition-all group'><div class='flex'><div class='col-auto pr-3'><div class='w-12 h-12 leading-10 p-1 bg-gray-300 rounded-full text-center font-medium'>" + data.receiver_logo + "</div></div><div class='flex-1 overflow-hidden pt-2'><div class='flex justify-between leading-none pb-2'><div class='text-gray-900 text-sm truncate font-medium'>" + data.receiver_name + "</div><div id='message_time_"+ data.chat_thread_id +"'><div class='col-auto pl-3 text-xs text-gray-400 whitespace-no-wrap'>" + data.message_time + "</div></div></div><div class='text-gray-700 text-xs truncate leading-none' id='latest_message_"+ data.chat_thread_id +"'>"+ data.message + "</div></div></div></div></div>");
    }
    else {
      if(#{!current_page?(network_chats_path)}){
        $('.nav-messages').append("<div class='red-bubble text-white text-xs'>" + data.unopened_chat_threads + "</div>");
        var notification = toastr.info(data.message, data.username);
        $(notification).on('click', function(){
          url = "/n/messages?chat_thread_id=" + data.chat_thread_id;
          window.location.replace(url);
        })
      };

      $(".chat-box-" + data.chat_thread_id).append("<div class='flex mb-8 message_" + data.message_id + "' id='message_" + data.message_id + "'><div class='col-auto'><div class='w-8 h-8 sm:w-12 sm:h-12 rounded-full bg-secondary text-white p-1 text-2xl text-center'><i class='fa fa-user sm:leading-10 leading-6 align-top'></i></div></div><div class='col flex-1 max-w-screen-sm pl-4'><div class='text-sm text-gray-600 pb-1'>" + data.username + "</div><div class='bg-white py-3 px-6 rounded-2xl rounded-tl-none text-sm text-gray-500 inline-block chat-message'>" + data.message + "</div><div class='text-gray-500 text-xs pt-2'>" + data.time + "</div></div></div>");

      $("#chat_thread_" + data.chat_thread_id).remove();
      $('.messaging-messages-list').prepend("<div class='messaging-messages-list-item chat_item' data-thread_id= "+ data.chat_thread_id +" id='chat_thread_"+ data.chat_thread_id +"'><div class='p-3 block hover:bg-gray-100 transition-all group'><div class='flex'><div class='col-auto pr-3 unread-messages-notification'><span class='bubble text-xxs' id='bubble_" + data.chat_thread_id + "'>" + data.unread_messages_count + "</span><div class='w-12 h-12 leading-10 p-1 bg-gray-300 rounded-full text-center font-medium'>" + data.logo + "</div></div><div class='flex-1 overflow-hidden pt-2'><div class='flex justify-between leading-none pb-2'><div class='text-gray-900 text-sm truncate font-medium'>" + data.username + "</div><div id='message_time_"+ data.chat_thread_id +"'><div class='col-auto pl-3 text-xs text-gray-400 whitespace-no-wrap'>" + data.message_time + "</div></div></div><div class='text-gray-700 text-xs truncate leading-none' id='latest_message_"+ data.chat_thread_id +"'>"+ data.message + "</div></div></div></div></div>");

      $(".messaging-wrapper-messages").animate({scrollTop: $('.messaging-wrapper-messages').get(0).scrollHeight}, 500);
      $("#latest_message_" + data.chat_thread_id).html(data.message);
      $("#message_time_" + data.chat_thread_id).html("<div class='col-auto pl-3 text-xs text-gray-400 whitespace-no-wrap'>" + data.message_time + "</div>");

      if( $(".message_" + data.message_id).length > 0 ) {
        if($('.messaging-wrapper-messages').find('.message_' + data.message_id).length == 1) {
          $.ajax({
            url: "/n/messages/update_message_read_status",
            type: 'post',
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            data: { message_id: data.message_id }
          });
          $('.unread-messages-notification').find('#bubble_' + data.chat_thread_id).remove();
          $('#chat_thread_' + data.chat_thread_id).addClass('active-chat');
        }
      }
    }
  };

  var pusher = new Pusher('#{ENV["PUSHER_KEY"]}', {
    cluster: '#{ENV["PUSHER_CLUSTER"]}',
    encrypted: true
  });

- current_user.chat_threads.each do |chat_thread|
  :javascript
    channel = pusher.subscribe("chat_thread_" + #{chat_thread.id});
    channel.bind('new_msg', function(data) {
      updateChat(data);
    });
:javascript
  channel = pusher.subscribe("new_thread_" + #{current_user.id});
  channel.bind('new_thread', function(data) {
    channel = pusher.subscribe("chat_thread_" + data.chat_thread_id);
    channel.bind('new_msg', function(data) {
      updateChat(data);
    });
    updateChatList(data);
  });
